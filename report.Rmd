---
title: "internship_report"
author: "Junhao Wang"
date: "26/05/2022"
output: html_document
---

# Amber Community Data Analysis Program

### Abstract

This program is offered by Leanne Hyndman, the leader of Amber Community, and aims to find useful information through the available data provided by them or other contributors on the internet, and provide data-driven support.

To achieve this aim, I cleaned the data, did some exploration analysis, made the time series analysis and also compared

The data is from three source: Amber Community, adsmapsdata, and the government's website (https://www.coronavirus.vic.gov.au/victorian-coronavirus-covid-19-data)



### Background and Motivation

Amber Community, formerly Road Trauma Support Services Victoria, is a not-for-profit organization contributing to the safety and wellbeing of road users. To provide data-driven support


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = TRUE)
```

```{r}
# Load tidyverse packages
library(tidyverse)
library(readr)
library(janitor)
library(stringr)
library(lubridate)
library(fpp3)
library(absmapsdata)
library(sf)
library(leaflet)
library(RColorBrewer)
library(plotly)
library(ggiraph)

```

```{r}
# Read files as tibbles
referrals <- read_csv(file="referrals.csv")
postcode_population <- read_csv("postcode_population.csv")
```


```{r}
# Function to check if all values in a vector are equal
is_constant <- function(x) {
  isTRUE(all.equal(x, rep(x[1],length(x))))
}
```


```{r}
# Function to remove columns containing only missing values or all values equal
remove_meaningless_columns <- function(object) {
  all_miss <- colSums(is.na(object)) == NROW(object)
  all_equal <- apply(object, 2, is_constant)
  return(object[,!all_miss & !all_equal])
}
```

With the help and guidance of professor Rob Hyndman, I removed useless variables and cleaned the variable names and created the table referrals_clean1.
```{r}
# Create main tables as tibbles
referrals_clean1 <- referrals %>%
  janitor::clean_names() %>%
  remove_meaningless_columns() %>%
  arrange(date_received)%>%
  mutate(client_type = str_to_lower(client_type))
```
Then I checked the data type, name and value in each variable:
```{r}
#check variables' type
glimpse(referrals_clean1)
```
After checking that, I renamed the variable and combined the catogorical variables' values and created referrals_clean2.
```{r}
#change variable name
referrals_clean1<-referrals_clean1%>%rename(post_code=we_suggest_you_do,region=postcode)
```

```{r}
# combining
referrals_clean2<-referrals_clean1%>%
  mutate(client_type = recode(client_type, beareaved = "bereaved person", witnes= "witness","witnes on scene"="witness", .missing = "unknown"))%>%
  mutate(referred_by = recode(referred_by, .missing = "unknown"))
  
referrals_clean2 <- referrals_clean2 %>%
  mutate(
    client_type = if_else(str_detect(client_type, "bereaved"), "bereaved", client_type)
  ) %>%
  mutate(
    client_type = if_else(str_detect(client_type, "parent|fam|fr|mother|partner|work|employ"), "fam/fr of casualty", client_type)
  ) %>%
  mutate(
    client_type = if_else(str_detect(client_type, "driver"), "driver", client_type)
  ) %>%
  mutate(
    client_type = if_else(str_detect(client_type, "scooter|cyc|motor"), "rider", client_type)
  ) %>%
  mutate(
    client_type = if_else(str_detect(client_type, "injure|rage"), "other injured person", client_type)
  ) %>%
  mutate(
    client_type = if_else(str_detect(client_type, "witness|scene"), "witness", client_type)
  ) %>%
  mutate(
    client_type = if_else(str_detect(client_type, "pass|pedes"), "passenger", client_type)
  ) %>%
  mutate(
    client_type = if_else(str_detect(client_type, "ccccc|group|emerg|second|inap"), "other", client_type)
  ) %>%
  mutate(
    referred_by = if_else(str_detect(referred_by, "General|Hospital|Social|Internet|GP|Ambulance|RTSSV|Solicitor|After|Agencies|Counsellor|Media|Metro"), "Other", referred_by)
  )
```

Next I created a new variable "day_of_week" to check whether more referrals are received on Monday

```{r}
referrals_clean3<-referrals_clean2%>%
  mutate(referred_by=str_to_lower(referred_by))%>%
  select(-x1)%>%
  mutate(day_of_week = wday(date_received, label = TRUE)) #, post_code = as.numeric(post_code)  can not find the place 8344 gipsland

referrals_clean3%>%group_by(day_of_week)%>%summarise(proportion=n()/8037*100)
```
According to the table above, there are more referrals on Monday than on other days of week. This might be because that usually some referrals on weekend are postponed to the following day, which is Monday, and this can also explain why Tuesday has second largest amount of referrals, and the rest of the week days(Wednesday, Thursday and Friday) have about the same amount, which is still significantly larger(around 40%) than weekend.

We can also have a look at the summary of client type variable

```{r}
# check the results  
client_type_count<-referrals_clean2%>%
  count(client_type)
referredby_count<-referrals_clean2%>%
  count(referred_by)  
client_type_count%>%arrange(desc(n))
```
From the tabel above we can see that the major source of client is from driver, witness and bereaved people.


and referred_by variable
```{r}
referredby_count%>%arrange(desc(n))
```

#### time related analysis


```{r}
ts_week<-referrals_clean3%>%
  filter(!is.na(date_received))%>%
  mutate(week = yearweek(date_received))%>%
  group_by(week)%>%summarise(referrals = n())%>%
  filter(week != yearweek("2016 Jun") & week != yearweek("2022 Apr"))%>%
  as_tsibble(index = week)
ts_week%>%fill_gaps()%>%
  autoplot()+
  geom_smooth(span = 0.4)

```



```{r}
ts_week%>%fill_gaps()%>%
  gg_season()+
  geom_smooth()
```


```{r}
ts_month<-referrals_clean3%>%
mutate(date_received = if_else(is.na(date_received), date_entered, date_received))%>%
  filter(!is.na(date_received))%>%
  mutate(month = yearmonth(date_received))%>%
  group_by(month)%>%summarise(referrals = n())%>%
  filter(month != yearmonth("2016 Jun") & month != yearmonth("2022 Apr"))%>%
  as_tsibble(index = month)
ts_month%>%fill_gaps()%>%
  gg_subseries()

```
From the plot above we can see that almost for every month there is a significant drop in year 2020, which can be the consequence of Australia's lock-down policy for COVID-19.
```{r}
fit<-ts_month%>%fill_gaps()%>%model(etsmonth = ETS(referrals))
report(fit)
```
This graph shows subseries of the referrals data by month. As is shown above the peaks in term of number of referrals are in March and October, and the troughs are in May and Sep. Most months show a downward trend from 2017 to 2022 but have troughs in 2020 or 2021, which may be a consequence of covid-19. But overall the seasonality is week as the ETC function suggests an MNN model which does not contain seasonal component.

Maybe the drop in the 2nd quarter is because the staff in the organization usually have a vocation due to the cold weather in 2nd quarter

```{r}
ts_month%>%fill_gaps()%>%
  gg_season()
```
From the graph above we can observe that the seasonality seems to be not very strong. But I also notice that the number of referrals usually drops in September, which may be due to the cold weather since staff are likely to go on a vocation to somewhere warm during this time.

```{r}
referrals_clean3%>%
  filter(!is.na(date_received)&!is.na(date_entered))%>%
  mutate(gap = date_entered-date_received)%>%
  filter(gap>-1&gap<8&date_received>"2020-03-01")%>%
  group_by(date_received)%>%
  summarise(gap=mean(gap))%>%
  as_tsibble(index = date_received)%>%
  autoplot(gap)+
  geom_smooth(span=.4)
```

Although not very apparent, we can still observe the downward pattern followed by a upwards pattern in this gap plot, conbining with the drop of refferals after the outbreak of covid-19, we can infer that the number of referrals does to some degree influenced the speed of processing referrals, and this indicates that the workload might be close to the upper limit of RTSSV.




```{r}
ts_month_week<-referrals_clean3%>%
mutate(date_received = if_else(is.na(date_received), date_entered, date_received))%>%
  filter(!is.na(date_received))%>%
  mutate(month = yearmonth(date_received))%>%
  filter(month != yearmonth("2016 Jun") & month != yearmonth("2022 Apr"))%>%group_by(month, day_of_week)%>%
  summarise(referrals = n())
ts_month_week%>%
  ggplot(aes(x = month, y = referrals, color = day_of_week)) +
  geom_line()
```
```{r}
postcode_population<-postcode_population%>%mutate(postcode=as.character(postcode))
```
```{r}
referrals_clean4<-referrals_clean3%>%
  group_by(post_code)%>%
  summarise(referrals=n())
mapdata<-postcode2021%>%
  left_join(referrals_clean4, by=c("postcode_2021"="post_code"))%>%
  left_join(postcode_population, by=c("postcode_2021"="postcode"))%>%
  select(cent_lat, cent_long, population, referrals, postcode_2021,geometry)
  
```



```{r}
mapdata[is.na(mapdata)] <- 0
mapdata1<-mapdata%>%
  summarise(postcode=postcode_2021,attractiveness=referrals/sum(referrals)-population/sum(population), lat = cent_lat, lng = cent_long, geometry=geometry,population=population, referral=referral)%>%mutate(attractiveness=1000*attractiveness, postcode=as.numeric(postcode))%>%filter(postcode>2999&postcode<4000)
```
```{r}
map <-
mapdata1 %>%
  ggplot() +
  geom_sf(aes(geometry = geometry, fill=attractiveness, text=paste("postcode:",postcode, "\n", "population:", population, "\n", "referral:",referral)),lwd=0, show.legend = TRUE)+  # use the geometry variable
  geom_point(aes(145.2,-37.8),color = "red",size=0.6)+
  scale_fill_viridis_c() +

  coord_sf()

ggplotly(map)
```

```{r}
pal<-colorBin(palette = "Reds", domain=mapdata1$attractiveness,n=5)
```

```{r}
leaflet(mapdata1)%>%
  addTiles()%>%
  addPolygons(lat=~lat,lng=~lng, label = ~postcode, color = "gray", fillColor = ~pal(mapdata1$attractiveness*10^4),fillOpacity = 1.0, weight = 1.0,opacity = 1.0)
    
```

```{r}
ts_month<-referrals_clean3%>%
mutate(date_received = if_else(is.na(date_received), date_entered, date_received))%>%
  filter(!is.na(date_received))%>%
  mutate(month = yearmonth(date_received))%>%
  group_by(month,client_type)%>%summarise(referrals = n())%>%
  filter(month != yearmonth("2016 Jun") & month != yearmonth("2022 Apr"))

```

```{r}
p<-ts_month%>%
  ggplot( aes(month, referrals,fill=client_type), position="fill") +
  geom_col()

ggplotly(p)
```
```{r}
ts_month<-referrals_clean3%>%
mutate(date_received = if_else(is.na(date_received), date_entered, date_received))%>%
  filter(!is.na(date_received))%>%
  mutate(month = yearmonth(date_received))%>%
  group_by(month,referred_by)%>%summarise(referrals = n())%>%
  filter(month != yearmonth("2016 Jun") & month != yearmonth("2022 Apr"))

```
```{r}
ts_month%>%
  plot_ly(x=~month, y=~referrals,type='bar' ,fill = ~referred_by)

```
As is shown above, the referrals from vsa disappeare